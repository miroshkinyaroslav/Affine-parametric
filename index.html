<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ª–∏–Ω–µ–π–Ω–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --primary: #0f172a;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --border: #cbd5e1;
            --text-main: #334155;
            --text-light: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --highlight: #fef3c7;
            --purple: #8b5cf6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            display: grid;
            gap: 2rem;
        }

        .panel {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .controls-header {
            display: flex;
            gap: 1.5rem;
            align-items: end;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-weight: 600;
            font-size: 0.85rem;
        }

        input[type="number"],
        input[type="text"] {
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }

        button {
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-secondary {
            background-color: white;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .matrix-wrapper {
            display: inline-flex;
            align-items: center;
            position: relative;
            padding: 0 10px;
            overflow-x: auto;
            max-width: 100%;
        }

        .matrix-wrapper::before,
        .matrix-wrapper::after {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            width: 12px;
            border: 2px solid var(--primary);
            pointer-events: none;
        }

        .matrix-wrapper::before {
            left: 0;
            border-right: none;
            border-radius: 8px 0 0 8px;
        }

        .matrix-wrapper::after {
            right: 0;
            border-left: none;
            border-radius: 0 8px 8px 0;
        }

        .matrix-grid {
            display: grid;
            gap: 8px;
            margin: 5px;
        }

        .matrix-cell {
            min-width: 60px;
            height: 40px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        .matrix-cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            background: transparent;
        }

        .matrix-cell input:focus {
            outline: none;
            background-color: #f0f9ff;
        }

        .matrix-cell.readonly {
            background-color: #f8fafc;
            border: none;
            font-weight: bold;
        }

        .matrix-cell.free-var {
            background-color: #d1fae5;
            border-color: var(--success);
        }

        .step-history {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .step-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .step-card.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .step-title {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .step-desc {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .formula-box {
            background: var(--highlight);
            border-left: 4px solid var(--warning);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .result-box {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid var(--success);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .result-box.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: var(--error);
        }

        .result-box h3 {
            color: var(--success);
            margin-bottom: 1rem;
        }

        .result-box.error h3 {
            color: var(--error);
        }

        .info-box {
            background: #f8fafc;
            border-left: 4px solid var(--accent);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .control-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .example-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .btn-example {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            background-color: #f1f5f9;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-example:hover {
            background-color: #e2e8f0;
        }

        /* Table Input Styles */
        .system-table-wrapper {
            overflow-x: auto;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
        }

        .system-table {
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        .system-table td {
            padding: 0 4px;
            white-space: nowrap;
        }

        .system-input-wrapper {
            display: inline-flex;
            align-items: center;
        }
    </style>
</head>

<body>
    <h1>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ª–∏–Ω–µ–π–Ω–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è</h1>
    <p class="subtitle">–ó–∞–¥–∞—Ç—å –ª–∏–Ω–µ–π–Ω–æ–µ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏–µ H –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏ –∏ —É–∫–∞–∑–∞—Ç—å –µ–≥–æ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å</p>
    <div class="app-container">
        <div id="inputPanel" class="panel">
            <h2>üìù –°–∏—Å—Ç–µ–º–∞ –ª–∏–Ω–µ–π–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π</h2>
            <div class="info-box">
                –í–≤–µ–¥–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∏ –ø—Ä–∞–≤—ã–µ —á–∞—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –ª–∏–Ω–µ–π–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π.
                <br>
                <small>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ (5), –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ –¥—Ä–æ–±–∏ (2.5) –∏ –æ–±—ã–∫–Ω–æ–≤–µ–Ω–Ω—ã–µ –¥—Ä–æ–±–∏ (1/3).</small>
            </div>

            <div class="controls-header">
                <div class="input-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–∞–≤–Ω–µ–Ω–∏–π:</label>
                    <input type="number" id="numEquations" min="1" max="8" value="3">
                </div>
                <div class="input-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:</label>
                    <input type="number" id="numVariables" min="2" max="8" value="5">
                </div>
                <button class="btn-secondary" onclick="app.generateInputGrid()">–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è</button>
            </div>

            <div id="systemInput" class="system-table-wrapper"></div>

            <div class="control-buttons">
                <button class="btn-primary" onclick="app.startSolver()">üöÄ –†–µ—à–∏—Ç—å</button>
            </div>

            <div class="example-buttons">
                <strong>–ü—Ä–∏–º–µ—Ä—ã:</strong>
                <button class="btn-example" onclick="app.loadExample('default')">–ü—Ä–∏–º–µ—Ä 1</button>
                <button class="btn-example" onclick="app.loadExample('ex1')">–ü—Ä–∏–º–µ—Ä 2</button>
                <button class="btn-example" onclick="app.loadExample('decimal')">–î—Ä–æ–±–∏ (0.5 –∏ 1/3)</button>
                <button class="btn-example" onclick="app.loadExample('nosol')">–ù–µ—Ç —Ä–µ—à–µ–Ω–∏–π</button>
            </div>
        </div>

        <div id="workflowContainer" class="workflow-area" style="display: none;">
            <div class="panel">
                <h2>üìä –†–µ—à–µ–Ω–∏–µ</h2>
                <div class="control-buttons">
                    <button id="btnNext" class="btn-primary" onclick="app.showNextStep()">–ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π
                        —à–∞–≥</button>
                    <button id="btnAll" class="btn-secondary" onclick="app.showAllSteps()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —à–∞–≥–∏</button>
                    <button class="btn-secondary" onclick="app.reset()">üîÑ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
                </div>
                <div id="historyList" class="step-history" style="margin-top: 2rem;"></div>
            </div>
        </div>
    </div>

    <script>
        class Fraction {
            constructor(num, den = 1) {
                if (den === 0) throw new Error("–ó–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω—É–ª–µ–º");

                // Ensure inputs are integers for GCD
                if (!Number.isInteger(num) || !Number.isInteger(den)) {
                    // Try to fix floating point issues if passed to constructor
                    // Note: Ideally use fromString static method
                }

                const common = this.gcd(Math.abs(Math.round(num)), Math.abs(Math.round(den)));
                this.num = Math.round(num / common);
                this.den = Math.round(den / common);

                if (this.den < 0) {
                    this.num = -this.num;
                    this.den = -this.den;
                }
            }

            gcd(a, b) { return b === 0 ? a : this.gcd(b, a % b); }

            add(other) { return new Fraction(this.num * other.den + other.num * this.den, this.den * other.den); }
            subtract(other) { return new Fraction(this.num * other.den - other.num * this.den, this.den * other.den); }
            multiply(other) { return new Fraction(this.num * other.num, this.den * other.den); }
            divide(other) {
                if (other.num === 0) throw new Error("–î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å");
                return new Fraction(this.num * other.den, this.den * other.num);
            }
            negate() { return new Fraction(-this.num, this.den); }
            equals(other) { return this.num === other.num && this.den === other.den; }
            isZero() { return this.num === 0; }

            toString() {
                if (this.den === 1) return this.num.toString();
                return `${this.num}/${this.den}`;
            }

            toLatex() {
                if (this.den === 1) return this.num.toString();
                if (this.num < 0) return `-\\frac{${-this.num}}{${this.den}}`;
                return `\\frac{${this.num}}{${this.den}}`;
            }

            static fromString(str) {
                str = String(str).trim();
                if (!str) return new Fraction(0);

                // Handle fraction x/y
                if (str.includes('/')) {
                    const parts = str.split('/');
                    if (parts.length !== 2) return new Fraction(0); // Fail safe

                    // Recursive call to handle decimals in fraction parts like 1.5/2
                    const num = parseFloat(parts[0]);
                    const den = parseFloat(parts[1]);

                    // Convert float/float to integer/integer
                    const fNum = Fraction.fromFloat(num);
                    const fDen = Fraction.fromFloat(den);
                    return fNum.divide(fDen);
                }

                // Handle decimal or integer
                return Fraction.fromFloat(parseFloat(str));
            }

            static fromFloat(x) {
                if (Number.isInteger(x)) return new Fraction(x);
                if (isNaN(x)) return new Fraction(0);

                const tolerance = 1.0E-6;
                let h1 = 1, h2 = 0, k1 = 0, k2 = 1;
                let b = x;
                do {
                    let a = Math.floor(b);
                    let aux = h1; h1 = a * h1 + h2; h2 = aux;
                    aux = k1; k1 = a * k1 + k2; k2 = aux;
                    b = 1 / (b - a);
                } while (Math.abs(x - h1 / k1) > x * tolerance);

                return new Fraction(h1, k1);
            }
        }

        class AffineParametricSolver {
            constructor(equations, rhs) {
                // Parse strings to Fractions here
                this.equations = equations.map(row => row.map(x => Fraction.fromString(x)));
                this.rhs = rhs.map(x => Fraction.fromString(x));
                this.rows = this.equations.length;
                this.cols = this.equations[0].length;
                this.steps = [];
                this.isConsistent = true;

                // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ [A|b]
                this.augmented = [];
                for (let i = 0; i < this.rows; i++) {
                    this.augmented[i] = [...this.equations[i], this.rhs[i]];
                }
            }

            calculate() {
                this.addStep(
                    "–ò—Å—Ö–æ–¥–Ω–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ [A|b]",
                    "–°–æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É —Å–∏—Å—Ç–µ–º—ã –ª–∏–Ω–µ–π–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π:",
                    this.copyMatrix(this.augmented)
                );

                this.gaussElimination();

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è –∫ —Å—Ç—É–ø–µ–Ω—á–∞—Ç–æ–º—É –≤–∏–¥—É
                if (!this.checkConsistency()) {
                    return;
                }

                this.findRank();
                this.findFreeVariables();
                this.expressBasicThroughFree();
                this.buildParametricForm();
            }

            gaussElimination() {
                const m = this.augmented;
                let currentRow = 0;

                for (let col = 0; col < this.cols && currentRow < this.rows; col++) {
                    // –ü–æ–∏—Å–∫ –Ω–µ–Ω—É–ª–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                    let pivotRow = -1;
                    for (let row = currentRow; row < this.rows; row++) {
                        if (!m[row][col].isZero()) {
                            pivotRow = row;
                            break;
                        }
                    }

                    if (pivotRow === -1) continue;

                    // –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫
                    if (pivotRow !== currentRow) {
                        [m[currentRow], m[pivotRow]] = [m[pivotRow], m[currentRow]];
                        this.addStep(
                            `–ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫ ${currentRow + 1} ‚Üî ${pivotRow + 1}`,
                            "–ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–Ω—É–ª–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞",
                            this.copyMatrix(m)
                        );
                    }

                    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏
                    const pivot = m[currentRow][col];
                    if (!pivot.equals(new Fraction(1))) {
                        for (let j = 0; j <= this.cols; j++) {
                            m[currentRow][j] = m[currentRow][j].divide(pivot);
                        }
                        this.addStep(
                            `–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏ ${currentRow + 1}`,
                            `–î–µ–ª–∏–º —Å—Ç—Ä–æ–∫—É ${currentRow + 1} –Ω–∞ ${pivot.toString()}`,
                            this.copyMatrix(m)
                        );
                    }

                    // –û–±–Ω—É–ª–µ–Ω–∏–µ –ø–æ–¥ pivot
                    let hasElimination = false;
                    for (let row = currentRow + 1; row < this.rows; row++) {
                        if (!m[row][col].isZero()) {
                            hasElimination = true;
                            const factor = m[row][col];
                            for (let j = 0; j <= this.cols; j++) {
                                m[row][j] = m[row][j].subtract(m[currentRow][j].multiply(factor));
                            }
                        }
                    }

                    // –û–±–Ω—É–ª–µ–Ω–∏–µ –ù–ê–î pivot (Gauss-Jordan) –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
                    for (let row = 0; row < currentRow; row++) {
                        if (!m[row][col].isZero()) {
                            hasElimination = true;
                            const factor = m[row][col];
                            for (let j = 0; j <= this.cols; j++) {
                                m[row][j] = m[row][j].subtract(m[currentRow][j].multiply(factor));
                            }
                        }
                    }

                    if (hasElimination) {
                        this.addStep(
                            `–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Å—Ç–æ–ª–±—Ü–µ ${col + 1}`,
                            `–ü—Ä–∏–≤–æ–¥–∏–º —Å—Ç–æ–ª–±–µ—Ü –∫ –µ–¥–∏–Ω–∏—á–Ω–æ–º—É –æ—Ä—Ç—É`,
                            this.copyMatrix(m)
                        );
                    }

                    currentRow++;
                }
            }

            checkConsistency() {
                // –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ [0 0 ... 0 | b], –≥–¥–µ b != 0
                for (let i = 0; i < this.rows; i++) {
                    let allZeros = true;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–∏—Å–∫–ª—é—á–∞—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü)
                    for (let j = 0; j < this.cols; j++) {
                        if (!this.augmented[i][j].isZero()) {
                            allZeros = false;
                            break;
                        }
                    }

                    // –ï—Å–ª–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –Ω—É–ª–∏, –∞ —Å–≤–æ–±–æ–¥–Ω—ã–π —á–ª–µ–Ω (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü) –Ω–µ –Ω–æ–ª—å
                    if (allZeros && !this.augmented[i][this.cols].isZero()) {
                        this.isConsistent = false;
                        this.addStep(
                            "‚õî –°–∏—Å—Ç–µ–º–∞ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–Ω–∞",
                            `–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∏–¥–∞ $0 = ${this.augmented[i][this.cols].toLatex()}$, —á—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.`,
                            null,
                            `\\emptyset`,
                            true, // isFinal
                            true // isError
                        );
                        return false;
                    }
                }
                return true;
            }

            findRank() {
                let rank = 0;
                for (let i = 0; i < this.rows; i++) {
                    let hasNonZero = false;
                    for (let j = 0; j < this.cols; j++) {
                        if (!this.augmented[i][j].isZero()) {
                            hasNonZero = true;
                            break;
                        }
                    }
                    if (hasNonZero) rank++;
                }
                this.rank = rank;

                this.addStep(
                    "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–Ω–≥–∞ —Å–∏—Å—Ç–µ–º—ã",
                    `–†–∞–Ω–≥ —Å–∏—Å—Ç–µ–º—ã r = ${rank} (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–Ω—É–ª–µ–≤—ã—Ö —Å—Ç—Ä–æ–∫)`,
                    null,
                    `r = ${rank}`
                );
            }

            findFreeVariables() {
                const basicVars = [];
                const freeVars = [];

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–∏—Å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–π –Ω–µ–Ω—É–ª–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å—Ç—Ä–æ–∫–µ)
                for (let i = 0; i < this.rows; i++) {
                    for (let j = 0; j < this.cols; j++) {
                        if (!this.augmented[i][j].isZero()) {
                            // Check if this column is already a basic var (shouldn't be in RREF but good safety)
                            if (!basicVars.includes(j)) {
                                basicVars.push(j);
                            }
                            break;
                        }
                    }
                }

                // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ - —Å–≤–æ–±–æ–¥–Ω—ã–µ
                for (let j = 0; j < this.cols; j++) {
                    if (!basicVars.includes(j)) {
                        freeVars.push(j);
                    }
                }

                this.basicVars = basicVars;
                this.freeVars = freeVars;
                this.dimension = freeVars.length;

                const freeVarNames = freeVars.length > 0 ? freeVars.map(i => `x_{${i + 1}}`).join(', ') : '\\emptyset';
                const basicVarNames = basicVars.map(i => `x_{${i + 1}}`).join(', ');

                this.addStep(
                    "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö",
                    `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: k = n - r = ${this.cols} - ${this.rank} = ${this.dimension}<br>` +
                    `–ë–∞–∑–∏—Å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: ${basicVarNames}<br>` +
                    `–°–≤–æ–±–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: ${freeVarNames}`,
                    null,
                    `\\text{dim}(H) = ${this.dimension}`
                );
            }

            expressBasicThroughFree() {
                const expressions = [];

                for (let i = 0; i < this.basicVars.length; i++) {
                    const basicVar = this.basicVars[i];
                    // Find the row corresponding to this basic variable
                    let rowIdx = -1;
                    for (let r = 0; r < this.rows; r++) {
                        if (!this.augmented[r][basicVar].isZero()) {
                            rowIdx = r;
                            break;
                        }
                    }

                    if (rowIdx === -1) continue;

                    let expr = `x_{${basicVar + 1}} = ${this.augmented[rowIdx][this.cols].toLatex()}`;

                    for (let k = 0; k < this.freeVars.length; k++) {
                        const freeVar = this.freeVars[k];
                        const val = this.augmented[rowIdx][freeVar];
                        if (!val.isZero()) {
                            const coef = val.negate();
                            const sign = coef.num >= 0 ? '+' : '';
                            expr += ` ${sign} ${coef.toLatex()} x_{${freeVar + 1}}`;
                        }
                    }
                    expressions.push(expr);
                }

                this.expressions = expressions;

                this.addStep(
                    "–í—ã—Ä–∞–∂–µ–Ω–∏–µ –±–∞–∑–∏—Å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö",
                    "–í—ã—Ä–∞–∂–∞–µ–º –±–∞–∑–∏—Å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã–µ:",
                    null,
                    expressions.length > 0 ? expressions.join(' \\\\ ') : 'x_i = \\text{const}'
                );
            }

            buildParametricForm() {
                // –°—Ç—Ä–æ–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É
                const params = this.freeVars.map((v, i) => `t_{${i + 1}}`);

                // –í–µ–∫—Ç–æ—Ä x0 (—á–∞—Å—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤—Å–µ—Ö —Å–≤–æ–±–æ–¥–Ω—ã—Ö = 0)
                const x0 = Array(this.cols).fill(new Fraction(0));

                // Fill x0 for basic variables
                for (let i = 0; i < this.basicVars.length; i++) {
                    const basicVar = this.basicVars[i];
                    // Find row
                    for (let r = 0; r < this.rows; r++) {
                        if (!this.augmented[r][basicVar].isZero()) {
                            x0[basicVar] = this.augmented[r][this.cols];
                            break;
                        }
                    }
                }

                // –í–µ–∫—Ç–æ—Ä—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
                const directions = [];
                for (let k = 0; k < this.freeVars.length; k++) {
                    const v = Array(this.cols).fill(new Fraction(0));
                    const freeVarIndex = this.freeVars[k];
                    v[freeVarIndex] = new Fraction(1);

                    // Calculate basic variables for this direction vector
                    for (let i = 0; i < this.basicVars.length; i++) {
                        const basicVar = this.basicVars[i];
                        // Find row
                        for (let r = 0; r < this.rows; r++) {
                            if (!this.augmented[r][basicVar].isZero()) {
                                // Coeff is -1 * matrix value because moved to RHS
                                const val = this.augmented[r][freeVarIndex];
                                v[basicVar] = val.negate();
                                break;
                            }
                        }
                    }

                    directions.push(v);
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º LaTeX
                let latex = '';
                if (params.length === 0) {
                    latex = 'x = x_0';
                } else {
                    latex = 'x = x_0 + ';
                    for (let k = 0; k < params.length; k++) {
                        latex += `${params[k]} v_{${k + 1}}`;
                        if (k < params.length - 1) latex += ' + ';
                    }
                }

                latex += ' \\\\ x_0 = \\begin{pmatrix}';
                latex += x0.map(f => f.toLatex()).join(' \\\\ ');
                latex += '\\end{pmatrix}';

                for (let k = 0; k < directions.length; k++) {
                    latex += `, \\quad v_{${k + 1}} = \\begin{pmatrix}`;
                    latex += directions[k].map(f => f.toLatex()).join(' \\\\ ');
                    latex += '\\end{pmatrix}';
                }

                this.addStep(
                    "‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ—à–µ–Ω–∏—è",
                    `–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –ª–∏–Ω–µ–π–Ω–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è: <strong>dim(H) = ${this.dimension}</strong><br><br>` +
                    `–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ:`,
                    null,
                    latex,
                    true
                );
            }

            copyMatrix(m) {
                return m.map(row => row.map(f => new Fraction(f.num, f.den)));
            }

            addStep(title, desc, matrix = null, latex = null, isFinal = false, isError = false) {
                this.steps.push({ title, desc, matrix, latex, isFinal, isError });
            }
        }

        const app = {
            mainSolver: null,
            currentStepIndex: 0,

            init() {
                this.generateInputGrid();
                setTimeout(() => this.renderAllMath(), 500);
            },

            generateInputGrid() {
                const numEq = parseInt(document.getElementById('numEquations').value);
                const numVar = parseInt(document.getElementById('numVariables').value);

                let html = '<table class="system-table">';
                for (let i = 0; i < numEq; i++) {
                    html += '<tr>';
                    for (let j = 0; j < numVar; j++) {
                        html += `<td>`;
                        html += `<div class="system-input-wrapper">`
                        html += `<input type="text" data-r="${i}" data-c="${j}" value="0" style="width:50px;text-align:center;" onkeypress="app.handleEnter(event)">`;
                        html += `<span style="margin-left:4px;">x<sub>${j + 1}</sub></span>`;
                        if (j < numVar - 1) html += '<span style="margin:0 4px;">+</span>';
                        html += `</div></td>`;
                    }
                    html += `<td style="padding:0 8px;">=</td>`;
                    html += `<td><input type="text" data-r="${i}" data-c="rhs" value="0" style="width:50px;text-align:center;" onkeypress="app.handleEnter(event)"></td>`;
                    html += '</tr>';
                }
                html += '</table>';

                document.getElementById('systemInput').innerHTML = html;
            },

            handleEnter(e) {
                if (e.key === 'Enter') {
                    this.startSolver();
                }
            },

            renderAllMath() {
                if (typeof renderMathInElement !== 'undefined') {
                    renderMathInElement(document.body, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false }
                        ],
                        throwOnError: false
                    });
                }
            },

            createAugmentedMatrixHTML(matrix) {
                const rows = matrix.length;
                const cols = matrix[0].length - 1;
                let html = '<div style="display:flex;justify-content:center;"><div class="matrix-wrapper">';
                html += `<div class="matrix-grid" style="grid-template-columns:repeat(${cols + 1},60px);">`;
                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j <= cols; j++) {
                        const cls = j === cols ? 'free-var' : '';
                        html += `<div class="matrix-cell readonly ${cls}">${matrix[i][j].toString()}</div>`;
                    }
                }
                html += '</div></div></div>';
                return html;
            },

            loadExample(key) {
                const examples = {
                    'default': {
                        numEq: 3,
                        numVar: 5,
                        data: [
                            [1, 2, 1, -2, 1, 2],
                            [3, -1, 2, 2, 0, 2],
                            [2, -4, 1, 4, -1, 2]
                        ]
                    },
                    'ex1': {
                        numEq: 2,
                        numVar: 4,
                        data: [
                            [1, 1, 1, 1, 4],
                            [1, -1, 2, 0, 2]
                        ]
                    },
                    'decimal': {
                        numEq: 2,
                        numVar: 3,
                        data: [
                            [0.5, 1, "1/3", 2],
                            [1.5, -2, 0, 1]
                        ]
                    },
                    'nosol': {
                        numEq: 3,
                        numVar: 3,
                        data: [
                            [1, 1, 1, 3],
                            [1, 1, 1, 4], // x+y+z = 3 –∏ x+y+z = 4 -> –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
                            [0, 0, 0, 0]
                        ]
                    }
                };

                const example = examples[key];
                if (!example) return;

                document.getElementById('numEquations').value = example.numEq;
                document.getElementById('numVariables').value = example.numVar;
                this.generateInputGrid();

                setTimeout(() => {
                    const inputs = document.querySelectorAll('#systemInput input');
                    inputs.forEach(inp => {
                        const r = parseInt(inp.dataset.r);
                        const c = inp.dataset.c;
                        // Safety check
                        if (r >= example.data.length) return;

                        if (c === 'rhs') {
                            inp.value = example.data[r][example.numVar];
                        } else {
                            const col = parseInt(c);
                            if (col < example.data[r].length) {
                                inp.value = example.data[r][col];
                            }
                        }
                    });
                }, 50);
            },

            reset() {
                document.getElementById('workflowContainer').style.display = 'none';
                document.getElementById('inputPanel').style.display = 'block';
                document.getElementById('historyList').innerHTML = '';
                this.mainSolver = null;
                this.currentStepIndex = 0;
            },

            startSolver() {
                const numEq = parseInt(document.getElementById('numEquations').value);
                const numVar = parseInt(document.getElementById('numVariables').value);

                const equations = Array(numEq).fill(0).map(() => Array(numVar).fill("0"));
                const rhs = Array(numEq).fill("0");

                const inputs = document.querySelectorAll('#systemInput input');
                inputs.forEach(inp => {
                    const r = parseInt(inp.dataset.r);
                    const c = inp.dataset.c;
                    const value = inp.value.trim() || "0"; // Keep as string!

                    if (c === 'rhs') {
                        rhs[r] = value;
                    } else {
                        equations[r][parseInt(c)] = value;
                    }
                });

                try {
                    this.mainSolver = new AffineParametricSolver(equations, rhs);
                    this.mainSolver.calculate();
                    document.getElementById('inputPanel').style.display = 'none';
                    document.getElementById('workflowContainer').style.display = 'grid';
                    this.currentStepIndex = 0;
                    this.renderHistory();
                    this.updateButtons();
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–∞—Ö: " + e.message + "\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.");
                    console.error(e);
                }
            },

            renderHistory() {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                for (let i = 0; i <= this.currentStepIndex; i++) {
                    const step = this.mainSolver.steps[i];
                    const div = document.createElement('div');
                    div.className = `step-card ${i === this.currentStepIndex ? 'active' : ''}`;

                    let content = `
                        <div class="step-title">
                            <span>–®–∞–≥ ${i}</span>
                            <span>${step.title}</span>
                        </div>
                        <div class="step-desc">${step.desc}</div>
                    `;

                    if (step.latex) {
                        content += `<div class="formula-box">$$${step.latex}$$</div>`;
                    }

                    if (step.matrix) {
                        content += `<div style="margin-top:1rem;">${this.createAugmentedMatrixHTML(step.matrix)}</div>`;
                    }

                    if (step.isFinal) {
                        const isError = step.isError;
                        content += `<div class="result-box ${isError ? 'error' : ''}">
                            <h3>${isError ? '‚õî –†–µ—à–µ–Ω–∏–π –Ω–µ—Ç' : '‚úÖ –†–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ'}</h3>
                            <p>${isError ? '–°–∏—Å—Ç–µ–º–∞ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–Ω–∞.' : '–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ –ª–∏–Ω–µ–π–Ω–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è –Ω–∞–π–¥–µ–Ω–∞!'}</p>
                        </div>`;
                    }

                    div.innerHTML = content;
                    list.appendChild(div);
                }
                setTimeout(() => this.renderAllMath(), 100);
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            },

            showNextStep() {
                if (this.currentStepIndex < this.mainSolver.steps.length - 1) {
                    this.currentStepIndex++;
                    this.renderHistory();
                    this.updateButtons();
                }
            },

            showAllSteps() {
                this.currentStepIndex = this.mainSolver.steps.length - 1;
                this.renderHistory();
                this.updateButtons();
            },

            updateButtons() {
                const isFinished = this.currentStepIndex >= this.mainSolver.steps.length - 1;
                document.getElementById('btnNext').disabled = isFinished;
                document.getElementById('btnAll').disabled = isFinished;
                document.getElementById('btnNext').innerText = isFinished ? "‚úÖ –†–µ—à–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ" : "–ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥";
            }
        };

        app.init();
    </script>
</body>

</html>