<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ª–∏–Ω–µ–π–Ω–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --primary: #0f172a;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --border: #cbd5e1;
            --text-main: #334155;
            --text-light: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --highlight: #fef3c7;
            --purple: #8b5cf6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            display: grid;
            gap: 2rem;
        }

        .panel {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .controls-header {
            display: flex;
            gap: 1.5rem;
            align-items: end;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-weight: 600;
            font-size: 0.85rem;
        }

        input[type="number"], input[type="text"] {
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }

        button {
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-secondary {
            background-color: white;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .matrix-wrapper {
            display: inline-flex;
            align-items: center;
            position: relative;
            padding: 0 10px;
        }

        .matrix-wrapper::before,
        .matrix-wrapper::after {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            width: 12px;
            border: 2px solid var(--primary);
        }

        .matrix-wrapper::before {
            left: 0;
            border-right: none;
            border-radius: 8px 0 0 8px;
        }

        .matrix-wrapper::after {
            right: 0;
            border-left: none;
            border-radius: 0 8px 8px 0;
        }

        .matrix-grid {
            display: grid;
            gap: 8px;
            margin: 5px;
        }

        .matrix-cell {
            min-width: 60px;
            height: 40px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        .matrix-cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
        }

        .matrix-cell.readonly {
            background-color: #f8fafc;
            border: none;
            font-weight: bold;
        }

        .matrix-cell.free-var {
            background-color: #d1fae5;
            border-color: var(--success);
        }

        .step-history {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .step-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .step-card.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .step-title {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .step-desc {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .formula-box {
            background: var(--highlight);
            border-left: 4px solid var(--warning);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .result-box {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid var(--success);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .result-box h3 {
            color: var(--success);
            margin-bottom: 1rem;
        }

        .info-box {
            background: #f8fafc;
            border-left: 4px solid var(--accent);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .control-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .example-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .btn-example {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            background-color: #f1f5f9;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-example:hover {
            background-color: #e2e8f0;
        }
    </style>
</head>

<body>
    <h1>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ª–∏–Ω–µ–π–Ω–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è</h1>
    <p class="subtitle">–ó–∞–¥–∞—Ç—å –ª–∏–Ω–µ–π–Ω–æ–µ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏–µ H –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏ –∏ —É–∫–∞–∑–∞—Ç—å –µ–≥–æ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å</p>
    <div class="app-container">
        <div id="inputPanel" class="panel">
            <h2>üìù –°–∏—Å—Ç–µ–º–∞ –ª–∏–Ω–µ–π–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π</h2>
            <div class="info-box">
                –í–≤–µ–¥–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∏ –ø—Ä–∞–≤—ã–µ —á–∞—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –ª–∏–Ω–µ–π–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π
            </div>

            <div class="controls-header">
                <div class="input-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–∞–≤–Ω–µ–Ω–∏–π:</label>
                    <input type="number" id="numEquations" min="1" max="5" value="3">
                </div>
                <div class="input-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:</label>
                    <input type="number" id="numVariables" min="2" max="6" value="5">
                </div>
                <button class="btn-secondary" onclick="app.generateInputGrid()">–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è</button>
            </div>

            <div id="systemInput" style="margin: 1.5rem 0;"></div>

            <div class="control-buttons">
                <button class="btn-primary" onclick="app.startSolver()">üöÄ –†–µ—à–∏—Ç—å</button>
            </div>

            <div class="example-buttons">
                <strong>–ü—Ä–∏–º–µ—Ä—ã:</strong>
                <button class="btn-example" onclick="app.loadExample('default')">–ü—Ä–∏–º–µ—Ä –∏–∑ —É—Å–ª–æ–≤–∏—è</button>
                <button class="btn-example" onclick="app.loadExample('ex1')">–ü—Ä–∏–º–µ—Ä 2</button>
            </div>
        </div>

        <div id="workflowContainer" class="workflow-area" style="display: none;">
            <div class="panel">
                <h2>üìä –†–µ—à–µ–Ω–∏–µ</h2>
                <div class="control-buttons">
                    <button id="btnNext" class="btn-primary" onclick="app.showNextStep()">–ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥</button>
                    <button id="btnAll" class="btn-secondary" onclick="app.showAllSteps()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —à–∞–≥–∏</button>
                    <button class="btn-secondary" onclick="app.reset()">üîÑ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
                </div>
                <div id="historyList" class="step-history" style="margin-top: 2rem;"></div>
            </div>
        </div>
    </div>

    <script>
        class Fraction {
            constructor(num, den = 1) {
                if (den === 0) throw new Error("–ó–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω—É–ª–µ–º");
                const g = this.gcd(Math.abs(num), Math.abs(den));
                this.num = num / g; this.den = den / g;
                if (this.den < 0) { this.num = -this.num; this.den = -this.den; }
            }
            gcd(a, b) { return b === 0 ? a : this.gcd(b, a % b); }
            add(other) { return new Fraction(this.num * other.den + other.num * this.den, this.den * other.den); }
            subtract(other) { return new Fraction(this.num * other.den - other.num * this.den, this.den * other.den); }
            multiply(other) { return new Fraction(this.num * other.num, this.den * other.den); }
            divide(other) {
                if (other.num === 0) throw new Error("–î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å");
                return new Fraction(this.num * other.den, this.den * other.num);
            }
            negate() { return new Fraction(-this.num, this.den); }
            equals(other) { return this.num === other.num && this.den === other.den; }
            isZero() { return this.num === 0; }
            toString() { return this.den === 1 ? this.num.toString() : `${this.num}/${this.den}`; }
            toLatex() {
                if (this.den === 1) return this.num.toString();
                if (this.num < 0) return `-\\frac{${-this.num}}{${this.den}}`;
                return `\\frac{${this.num}}{${this.den}}`;
            }
            static fromString(str) {
                str = str.trim();
                if (str.includes('/')) {
                    const [n, d] = str.split('/').map(x => parseInt(x.trim()));
                    return new Fraction(n, d);
                }
                return new Fraction(parseInt(str), 1);
            }
        }

        class AffineParametricSolver {
            constructor(equations, rhs) {
                this.equations = equations.map(row => row.map(x => new Fraction(x)));
                this.rhs = rhs.map(x => new Fraction(x));
                this.rows = this.equations.length;
                this.cols = this.equations[0].length;
                this.steps = [];

                // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ [A|b]
                this.augmented = [];
                for (let i = 0; i < this.rows; i++) {
                    this.augmented[i] = [...this.equations[i], this.rhs[i]];
                }
            }

            calculate() {
                this.addStep(
                    "–ò—Å—Ö–æ–¥–Ω–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ [A|b]",
                    "–°–æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É —Å–∏—Å—Ç–µ–º—ã –ª–∏–Ω–µ–π–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π:",
                    this.copyMatrix(this.augmented)
                );

                this.gaussElimination();
                this.findRank();
                this.findFreeVariables();
                this.expressBasicThroughFree();
                this.buildParametricForm();
            }

            gaussElimination() {
                const m = this.augmented;
                let currentRow = 0;

                for (let col = 0; col < this.cols && currentRow < this.rows; col++) {
                    // –ü–æ–∏—Å–∫ –Ω–µ–Ω—É–ª–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                    let pivotRow = -1;
                    for (let row = currentRow; row < this.rows; row++) {
                        if (!m[row][col].isZero()) {
                            pivotRow = row;
                            break;
                        }
                    }

                    if (pivotRow === -1) continue;

                    // –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫
                    if (pivotRow !== currentRow) {
                        [m[currentRow], m[pivotRow]] = [m[pivotRow], m[currentRow]];
                        this.addStep(
                            `–ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫ ${currentRow + 1} ‚Üî ${pivotRow + 1}`,
                            "–ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–Ω—É–ª–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞",
                            this.copyMatrix(m)
                        );
                    }

                    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏
                    const pivot = m[currentRow][col];
                    if (!pivot.equals(new Fraction(1))) {
                        for (let j = 0; j <= this.cols; j++) {
                            m[currentRow][j] = m[currentRow][j].divide(pivot);
                        }
                        this.addStep(
                            `–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏ ${currentRow + 1}`,
                            `–î–µ–ª–∏–º —Å—Ç—Ä–æ–∫—É ${currentRow + 1} –Ω–∞ ${pivot.toString()}`,
                            this.copyMatrix(m)
                        );
                    }

                    // –û–±–Ω—É–ª–µ–Ω–∏–µ –ø–æ–¥ pivot
                    let hasElimination = false;
                    for (let row = currentRow + 1; row < this.rows; row++) {
                        if (!m[row][col].isZero()) {
                            hasElimination = true;
                            const factor = m[row][col];
                            for (let j = 0; j <= this.cols; j++) {
                                m[row][j] = m[row][j].subtract(m[currentRow][j].multiply(factor));
                            }
                        }
                    }

                    if (hasElimination) {
                        this.addStep(
                            `–û–±–Ω—É–ª–µ–Ω–∏–µ –ø–æ–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–º (${currentRow + 1}, ${col + 1})`,
                            `–í—ã—á–∏—Ç–∞–µ–º —Å—Ç—Ä–æ–∫—É ${currentRow + 1} –∏–∑ –Ω–∏–∂–µ–ª–µ–∂–∞—â–∏—Ö —Å—Ç—Ä–æ–∫`,
                            this.copyMatrix(m)
                        );
                    }

                    currentRow++;
                }

                this.addStep(
                    "–°—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π –≤–∏–¥ –º–∞—Ç—Ä–∏—Ü—ã",
                    "–ü—Ä—è–º–æ–π —Ö–æ–¥ –º–µ—Ç–æ–¥–∞ –ì–∞—É—Å—Å–∞ –∑–∞–≤–µ—Ä—à–µ–Ω",
                    this.copyMatrix(m)
                );
            }

            findRank() {
                let rank = 0;
                for (let i = 0; i < this.rows; i++) {
                    let hasNonZero = false;
                    for (let j = 0; j < this.cols; j++) {
                        if (!this.augmented[i][j].isZero()) {
                            hasNonZero = true;
                            break;
                        }
                    }
                    if (hasNonZero) rank++;
                }
                this.rank = rank;

                this.addStep(
                    "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–Ω–≥–∞ —Å–∏—Å—Ç–µ–º—ã",
                    `–†–∞–Ω–≥ —Å–∏—Å—Ç–µ–º—ã r = ${rank} (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–Ω—É–ª–µ–≤—ã—Ö —Å—Ç—Ä–æ–∫)`,
                    null,
                    `r = ${rank}`
                );
            }

            findFreeVariables() {
                const basicVars = [];
                const freeVars = [];

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–∏—Å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–≥–¥–µ pivot-—ç–ª–µ–º–µ–Ω—Ç—ã)
                for (let i = 0; i < this.rank; i++) {
                    for (let j = 0; j < this.cols; j++) {
                        if (!this.augmented[i][j].isZero()) {
                            basicVars.push(j);
                            break;
                        }
                    }
                }

                // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ - —Å–≤–æ–±–æ–¥–Ω—ã–µ
                for (let j = 0; j < this.cols; j++) {
                    if (!basicVars.includes(j)) {
                        freeVars.push(j);
                    }
                }

                this.basicVars = basicVars;
                this.freeVars = freeVars;
                this.dimension = freeVars.length;

                const freeVarNames = freeVars.map(i => `x_{${i + 1}}`).join(', ');
                const basicVarNames = basicVars.map(i => `x_{${i + 1}}`).join(', ');

                this.addStep(
                    "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö",
                    `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: k = n - r = ${this.cols} - ${this.rank} = ${this.dimension}<br>` +
                    `–ë–∞–∑–∏—Å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: ${basicVarNames}<br>` +
                    `–°–≤–æ–±–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: ${freeVarNames}`,
                    null,
                    `\\text{dim}(H) = ${this.dimension}`
                );
            }

            expressBasicThroughFree() {
                const expressions = [];

                for (let i = 0; i < this.rank; i++) {
                    const basicVar = this.basicVars[i];
                    let expr = `x_{${basicVar + 1}} = ${this.augmented[i][this.cols].toLatex()}`;

                    for (let j = 0; j < this.cols; j++) {
                        if (j !== basicVar && !this.augmented[i][j].isZero()) {
                            const coef = this.augmented[i][j].negate();
                            const sign = coef.num >= 0 ? '+' : '';
                            expr += ` ${sign} ${coef.toLatex()} x_{${j + 1}}`;
                        }
                    }

                    expressions.push(expr);
                }

                this.expressions = expressions;

                this.addStep(
                    "–í—ã—Ä–∞–∂–µ–Ω–∏–µ –±–∞–∑–∏—Å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã–µ",
                    "–í—ã—Ä–∞–∂–∞–µ–º –±–∞–∑–∏—Å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã–µ –∏–∑ —Å—Ç—É–ø–µ–Ω—á–∞—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã:",
                    null,
                    expressions.join(' \\\\ ')
                );
            }

            buildParametricForm() {
                // –°—Ç—Ä–æ–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É
                const params = this.freeVars.map((v, i) => `t_{${i + 1}}`);

                // –í–µ–∫—Ç–æ—Ä x0 (—á–∞—Å—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤—Å–µ—Ö —Å–≤–æ–±–æ–¥–Ω—ã—Ö = 0)
                const x0 = Array(this.cols).fill(new Fraction(0));
                for (let i = 0; i < this.rank; i++) {
                    x0[this.basicVars[i]] = this.augmented[i][this.cols];
                }

                // –í–µ–∫—Ç–æ—Ä—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
                const directions = [];
                for (let k = 0; k < this.freeVars.length; k++) {
                    const v = Array(this.cols).fill(new Fraction(0));
                    v[this.freeVars[k]] = new Fraction(1);

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –±–∞–∑–∏—Å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                    for (let i = 0; i < this.rank; i++) {
                        const basicVar = this.basicVars[i];
                        const coef = this.augmented[i][this.freeVars[k]].negate();
                        v[basicVar] = coef;
                    }

                    directions.push(v);
                }

                this.x0 = x0;
                this.directions = directions;

                // –§–æ—Ä–º–∏—Ä—É–µ–º LaTeX
                let latex = 'x = x_0 + ';
                for (let k = 0; k < params.length; k++) {
                    latex += `${params[k]} v_{${k + 1}}`;
                    if (k < params.length - 1) latex += ' + ';
                }

                latex += ' \\\\ x_0 = \\begin{pmatrix}';
                latex += x0.map(f => f.toLatex()).join(' \\\\ ');
                latex += '\\end{pmatrix}';

                for (let k = 0; k < directions.length; k++) {
                    latex += `, \\quad v_{${k + 1}} = \\begin{pmatrix}`;
                    latex += directions[k].map(f => f.toLatex()).join(' \\\\ ');
                    latex += '\\end{pmatrix}`;
                }

                this.addStep(
                    "‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ—à–µ–Ω–∏—è",
                    `–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –ª–∏–Ω–µ–π–Ω–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è: <strong>dim(H) = ${this.dimension}</strong><br><br>` +
                    `–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ:`,
                    null,
                    latex,
                    true
                );
            }

            copyMatrix(m) {
                return m.map(row => row.map(f => new Fraction(f.num, f.den)));
            }

            addStep(title, desc, matrix = null, latex = null, isFinal = false) {
                this.steps.push({ title, desc, matrix, latex, isFinal });
            }
        }

        const app = {
            mainSolver: null,
            currentStepIndex: 0,

            init() {
                this.generateInputGrid();
                setTimeout(() => this.renderAllMath(), 500);
            },

            generateInputGrid() {
                const numEq = parseInt(document.getElementById('numEquations').value);
                const numVar = parseInt(document.getElementById('numVariables').value);

                let html = '<table style="border-collapse: collapse;">';
                for (let i = 0; i < numEq; i++) {
                    html += '<tr>';
                    for (let j = 0; j < numVar; j++) {
                        html += `<td style="padding:5px;">`;
                        html += `<input type="text" data-r="${i}" data-c="${j}" value="0" style="width:60px;text-align:center;">`;
                        html += `x<sub>${j + 1}</sub>`;
                        if (j < numVar - 1) html += ' +';
                        html += `</td>`;
                    }
                    html += `<td style="padding:5px;"> = </td>`;
                    html += `<td style="padding:5px;"><input type="text" data-r="${i}" data-c="rhs" value="0" style="width:60px;text-align:center;"></td>`;
                    html += '</tr>';
                }
                html += '</table>';

                document.getElementById('systemInput').innerHTML = html;
            },

            renderAllMath() {
                if (typeof renderMathInElement !== 'undefined') {
                    renderMathInElement(document.body, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false }
                        ],
                        throwOnError: false
                    });
                }
            },

            createAugmentedMatrixHTML(matrix) {
                const rows = matrix.length;
                const cols = matrix[0].length - 1;
                let html = '<div style="display:flex;justify-content:center;"><div class="matrix-wrapper">';
                html += `<div class="matrix-grid" style="grid-template-columns:repeat(${cols + 1},60px);">`;
                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j <= cols; j++) {
                        const cls = j === cols ? 'free-var' : '';
                        html += `<div class="matrix-cell readonly ${cls}">${matrix[i][j].toString()}</div>`;
                    }
                }
                html += '</div></div></div>';
                return html;
            },

            loadExample(key) {
                const examples = {
                    'default': {
                        numEq: 3,
                        numVar: 5,
                        data: [
                            [1, 2, 1, -2, 1, 2],
                            [3, -1, 2, 2, 0, 2],
                            [2, -4, 1, 4, -1, 2]
                        ]
                    },
                    'ex1': {
                        numEq: 2,
                        numVar: 4,
                        data: [
                            [1, 1, 1, 1, 4],
                            [1, -1, 2, 0, 2]
                        ]
                    }
                };

                const example = examples[key];
                document.getElementById('numEquations').value = example.numEq;
                document.getElementById('numVariables').value = example.numVar;
                this.generateInputGrid();

                setTimeout(() => {
                    const inputs = document.querySelectorAll('#systemInput input');
                    inputs.forEach(inp => {
                        const r = parseInt(inp.dataset.r);
                        const c = inp.dataset.c;
                        if (c === 'rhs') {
                            inp.value = example.data[r][example.numVar];
                        } else {
                            const col = parseInt(c);
                            inp.value = example.data[r][col];
                        }
                    });
                }, 100);
            },

            reset() {
                document.getElementById('workflowContainer').style.display = 'none';
                document.getElementById('inputPanel').style.display = 'block';
                document.getElementById('historyList').innerHTML = '';
                this.mainSolver = null;
                this.currentStepIndex = 0;
            },

            startSolver() {
                const numEq = parseInt(document.getElementById('numEquations').value);
                const numVar = parseInt(document.getElementById('numVariables').value);

                const equations = Array(numEq).fill(0).map(() => Array(numVar).fill(0));
                const rhs = Array(numEq).fill(0);

                const inputs = document.querySelectorAll('#systemInput input');
                inputs.forEach(inp => {
                    const r = parseInt(inp.dataset.r);
                    const c = inp.dataset.c;
                    const value = parseInt(inp.value) || 0;
                    if (c === 'rhs') {
                        rhs[r] = value;
                    } else {
                        equations[r][parseInt(c)] = value;
                    }
                });

                try {
                    this.mainSolver = new AffineParametricSolver(equations, rhs);
                    this.mainSolver.calculate();
                    document.getElementById('inputPanel').style.display = 'none';
                    document.getElementById('workflowContainer').style.display = 'grid';
                    this.currentStepIndex = 0;
                    this.renderHistory();
                    this.updateButtons();
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞: " + e.message);
                }
            },

            renderHistory() {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                for (let i = 0; i <= this.currentStepIndex; i++) {
                    const step = this.mainSolver.steps[i];
                    const div = document.createElement('div');
                    div.className = `step-card ${i === this.currentStepIndex ? 'active' : ''}`;

                    let content = `
                        <div class="step-title">
                            <span>–®–∞–≥ ${i}</span>
                            <span>${step.title}</span>
                        </div>
                        <div class="step-desc">${step.desc}</div>
                    `;

                    if (step.latex) {
                        content += `<div class="formula-box">$$${step.latex}$$</div>`;
                    }

                    if (step.matrix) {
                        content += `<div style="margin-top:1rem;">${this.createAugmentedMatrixHTML(step.matrix)}</div>`;
                    }

                    if (step.isFinal) {
                        content += `<div class="result-box">
                            <h3>‚úÖ –†–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ</h3>
                            <p>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ –ª–∏–Ω–µ–π–Ω–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è –Ω–∞–π–¥–µ–Ω–∞!</p>
                        </div>`;
                    }

                    div.innerHTML = content;
                    list.appendChild(div);
                }
                setTimeout(() => this.renderAllMath(), 100);
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            },

            showNextStep() {
                if (this.currentStepIndex < this.mainSolver.steps.length - 1) {
                    this.currentStepIndex++;
                    this.renderHistory();
                    this.updateButtons();
                }
            },

            showAllSteps() {
                this.currentStepIndex = this.mainSolver.steps.length - 1;
                this.renderHistory();
                this.updateButtons();
            },

            updateButtons() {
                const isFinished = this.currentStepIndex >= this.mainSolver.steps.length - 1;
                document.getElementById('btnNext').disabled = isFinished;
                document.getElementById('btnAll').disabled = isFinished;
                document.getElementById('btnNext').innerText = isFinished ? "‚úÖ –†–µ—à–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ" : "–ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥";
            }
        };

        app.init();
    </script>
</body>

</html>
